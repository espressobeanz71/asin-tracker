<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ASIN Tracker</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #0f1117;
      --surface: #1a1d2e;
      --border: #2e3150;
      --accent: #7c83ff;
      --green: #2ecc71;
      --red: #e74c3c;
      --orange: #f39c12;
      --text: #e0e0e0;
      --muted: #888;
    }

    body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }

    nav {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      padding: 0 32px;
      height: 56px;
      gap: 8px;
    }
    .nav-brand { font-size: 18px; font-weight: 700; color: var(--accent); margin-right: 24px; letter-spacing: 1px; }
    .nav-btn { padding: 7px 16px; border-radius: 6px; border: none; background: transparent; color: var(--muted); cursor: pointer; font-size: 13px; font-weight: 600; transition: all 0.2s; }
    .nav-btn:hover { color: var(--text); background: var(--border); }
    .nav-btn.active { color: var(--accent); background: rgba(124,131,255,0.12); }
    .nav-right { margin-left: auto; display: flex; align-items: center; gap: 10px; }
    #syncStatus { font-size: 12px; color: var(--muted); background: #12152a; padding: 4px 12px; border-radius: 6px; }

    .btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600; transition: opacity 0.2s; }
    .btn:hover { opacity: 0.85; }
    .btn-primary { background: var(--accent); color: #fff; }
    .btn-success { background: var(--green); color: #fff; }
    .btn-danger  { background: var(--red); color: #fff; }
    .btn-muted   { background: var(--border); color: var(--muted); }
    .btn-sm      { padding: 4px 10px; font-size: 11px; }
    .btn-orange  { background: var(--orange); color: #000; }

    .page { display: none; padding: 28px 32px; max-width: 1500px; margin: 0 auto; }
    .page.active { display: block; }

    .stats-bar { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 14px; margin-bottom: 24px; }
    .stat-card { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 16px; text-align: center; }
    .stat-card .num { font-size: 26px; font-weight: 700; color: var(--accent); }
    .stat-card .lbl { font-size: 11px; color: var(--muted); margin-top: 4px; }

    .panel { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 20px 24px; margin-bottom: 20px; }
    .panel h3 { font-size: 14px; color: var(--muted); margin-bottom: 16px; text-transform: uppercase; letter-spacing: 0.5px; }

    .form-row { display: flex; gap: 12px; flex-wrap: wrap; }
    .form-group { display: flex; flex-direction: column; gap: 6px; flex: 1; min-width: 130px; }
    .form-group label { font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; }
    .form-group input, .form-group select { background: var(--bg); border: 1px solid var(--border); border-radius: 6px; padding: 8px 12px; color: var(--text); font-size: 13px; }
    .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--accent); }
    .form-actions { display: flex; gap: 10px; margin-top: 16px; }

    .table-wrap { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; overflow: auto; }
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    thead th { background: #12152a; padding: 11px 14px; text-align: left; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--accent); white-space: nowrap; border-bottom: 1px solid var(--border); cursor: pointer; user-select: none; }
    thead th:hover { background: #1a1d3a; }
    tbody tr { border-bottom: 1px solid #1e2138; transition: background 0.15s; }
    tbody tr:hover { background: #1e2240; }
    tbody td { padding: 10px 14px; white-space: nowrap; }

    .asin-link { font-family: monospace; color: var(--accent); font-weight: 600; cursor: pointer; text-decoration: underline; }
    .title-cell { max-width: 200px; overflow: hidden; text-overflow: ellipsis; color: #ccc; }
    .delta-up   { color: var(--green); font-weight: 600; }
    .delta-down { color: var(--red); font-weight: 600; }
    .delta-zero { color: var(--muted); }
    .no-data    { color: #444; }
    .badge-amz  { background: var(--orange); color: #000; font-size: 10px; font-weight: 700; padding: 2px 6px; border-radius: 4px; }
    .roi-positive { color: var(--green); font-weight: 700; }
    .roi-negative { color: var(--red); font-weight: 700; }
    .status-msg { text-align: center; padding: 50px; color: #444; font-size: 14px; }

    .collapsible { display: none; }
    .collapsible.open { display: block; }

    .filter-builder { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 12px; margin-bottom: 16px; }
    .filter-row { background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 12px 14px; display: flex; align-items: center; gap: 10px; }
    .filter-row label { font-size: 12px; color: var(--text); flex: 1; }
    .filter-row select { background: var(--surface); border: 1px solid var(--border); border-radius: 5px; color: var(--text); font-size: 12px; padding: 4px 8px; }

    .detail-header { display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 24px; flex-wrap: wrap; gap: 12px; }
    .detail-title { font-size: 22px; font-weight: 700; color: var(--accent); }
    .detail-subtitle { font-size: 13px; color: var(--muted); margin-top: 4px; }

    .product-image-wrap { display: flex; align-items: flex-start; gap: 20px; margin-bottom: 24px; }
    .product-info { flex: 1; }
    .product-image { width: 120px; height: 120px; object-fit: contain; border-radius: 8px; border: 1px solid var(--border); background: #fff; padding: 6px; }

    .metrics-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 12px; margin-bottom: 24px; }
    .metric-card { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 14px 16px; }
    .metric-card .m-label { font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; }
    .metric-card .m-value { font-size: 20px; font-weight: 700; color: var(--text); }

    .delta-table { width: 100%; border-collapse: collapse; font-size: 13px; }
    .delta-table th { background: #12152a; padding: 10px 14px; text-align: left; font-size: 11px; color: var(--accent); text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid var(--border); }
    .delta-table td { padding: 10px 14px; border-bottom: 1px solid #1e2138; }

    .chart-container { position: relative; height: 280px; margin-bottom: 8px; }
    .period-btns { display: flex; gap: 8px; margin-bottom: 16px; }
    .period-btn { padding: 5px 14px; border-radius: 5px; border: 1px solid var(--border); background: transparent; color: var(--muted); font-size: 12px; cursor: pointer; transition: all 0.2s; }
    .period-btn.active { background: var(--accent); color: #fff; border-color: var(--accent); }

    .source-row { display: grid; grid-template-columns: 1fr 2fr 100px 80px auto; gap: 10px; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border); }
    .source-row:last-child { border-bottom: none; }
    .source-row input { background: var(--bg); border: 1px solid var(--border); border-radius: 6px; padding: 7px 10px; color: var(--text); font-size: 12px; width: 100%; }
    .source-row input:focus { outline: none; border-color: var(--accent); }
    .source-link { color: var(--accent); font-size: 12px; text-decoration: none; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; display: block; }
    .source-link:hover { text-decoration: underline; }

    .settings-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
    .setting-item { display: flex; flex-direction: column; gap: 6px; }
    .setting-item label { font-size: 12px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; }
    .setting-item input { background: var(--bg); border: 1px solid var(--border); border-radius: 6px; padding: 10px 14px; color: var(--text); font-size: 14px; }
    .setting-item input:focus { outline: none; border-color: var(--accent); }
    .setting-item .hint { font-size: 11px; color: #555; }
  </style>
</head>
<body>

<!-- NAV -->
<nav>
  <div class="nav-brand">‚ö° ASIN TRACKER</div>
  <button class="nav-btn active" onclick="showPage('dashboard')">Dashboard</button>
  <button class="nav-btn" onclick="showPage('velocity')">Velocity Filter</button>
  <button class="nav-btn" onclick="showPage('settings')">Settings</button>
  <div class="nav-right">
    <span id="syncStatus">Not synced yet</span>
    <button class="btn btn-success" onclick="syncKeepa()">üîÑ Sync Keepa</button>
  </div>
</nav>

<!-- ==================== DASHBOARD ==================== -->
<div class="page active" id="page-dashboard">
  <div class="stats-bar">
    <div class="stat-card"><div class="num" id="statTotal">‚Äî</div><div class="lbl">Total ASINs</div></div>
    <div class="stat-card"><div class="num" id="statAmazon">‚Äî</div><div class="lbl">Amazon Selling</div></div>
    <div class="stat-card"><div class="num" id="statPriceUp">‚Äî</div><div class="lbl">Price ‚Üë 30d</div></div>
    <div class="stat-card"><div class="num" id="statSellersDown">‚Äî</div><div class="lbl">Sellers ‚Üì 30d</div></div>
    <div class="stat-card"><div class="num" id="statRoiPos">‚Äî</div><div class="lbl">Positive ROI</div></div>
  </div>

  <div class="panel" style="margin-bottom:16px;">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <span style="font-weight:600;font-size:14px;">Manage ASINs</span>
      <button class="btn btn-primary" onclick="toggleAdd()">+ Add ASIN</button>
    </div>
    <div class="collapsible" id="addPanel" style="margin-top:16px;">
      <div class="form-row">
        <div class="form-group">
          <label>ASIN *</label>
          <input type="text" id="iAsin" placeholder="B08N5WRWNW" maxlength="10"/>
        </div>
        <div class="form-group">
          <label>Cost Price ($)</label>
          <input type="number" id="iCost" placeholder="0.00" step="0.01"/>
        </div>
        <div class="form-group">
          <label>Notes</label>
          <input type="text" id="iNotes" placeholder="Optional"/>
        </div>
      </div>
      <div class="form-actions">
        <button class="btn btn-primary" onclick="addAsin()">Add ASIN</button>
        <button class="btn btn-muted" onclick="toggleAdd()">Cancel</button>
      </div>
    </div>
  </div>

  <div style="margin-bottom:14px;display:flex;gap:10px;align-items:center;">
    <input type="text" id="dashSearch" placeholder="Search ASIN or title..."
      style="background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:8px 14px;color:var(--text);font-size:13px;width:260px;"
      oninput="renderDashboard()"/>
    <button class="btn btn-muted btn-sm" onclick="document.getElementById('dashSearch').value='';renderDashboard()">Clear</button>
  </div>

  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th onclick="dashSort('asin')">ASIN</th>
          <th onclick="dashSort('title')">Title</th>
          <th onclick="dashSort('current_price')">Price</th>
          <th onclick="dashSort('current_rank')">Rank</th>
          <th onclick="dashSort('current_sellers')">Sellers</th>
          <th>Amazon?</th>
          <th onclick="dashSort('weight')">Weight</th>
          <th onclick="dashSort('cost')">Cost</th>
          <th onclick="dashSort('roi')">ROI</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="dashBody">
        <tr><td colspan="11" class="status-msg">Loading...</td></tr>
      </tbody>
    </table>
  </div>
</div>
<!-- END DASHBOARD -->

<!-- ==================== VELOCITY FILTER ==================== -->
<div class="page" id="page-velocity">
  <div class="panel">
    <h3>Filter Builder ‚Äî combine any rules</h3>
    <div class="filter-builder">
      <div class="filter-row">
        <label>Buy Box Price</label>
        <select id="f_price_bb_dir">
          <option value="">Any</option>
          <option value="up">Trending ‚Üë</option>
          <option value="down">Trending ‚Üì</option>
        </select>
        <select id="f_price_bb_period">
          <option value="30">30d</option>
          <option value="90">90d</option>
          <option value="180">180d</option>
        </select>
      </div>
      <div class="filter-row">
        <label>Lowest New Price</label>
        <select id="f_price_new_dir">
          <option value="">Any</option>
          <option value="up">Trending ‚Üë</option>
          <option value="down">Trending ‚Üì</option>
        </select>
        <select id="f_price_new_period">
          <option value="30">30d</option>
          <option value="90">90d</option>
          <option value="180">180d</option>
        </select>
      </div>
      <div class="filter-row">
        <label>Seller Count</label>
        <select id="f_sellers_dir">
          <option value="">Any</option>
          <option value="down">Decreasing ‚Üì</option>
          <option value="up">Increasing ‚Üë</option>
        </select>
        <select id="f_sellers_period">
          <option value="30">30d</option>
          <option value="90">90d</option>
          <option value="180">180d</option>
        </select>
      </div>
      <div class="filter-row">
        <label>Sales Rank</label>
        <select id="f_rank_dir">
          <option value="">Any</option>
          <option value="down">Improving ‚Üì</option>
          <option value="up">Worsening ‚Üë</option>
        </select>
        <select id="f_rank_period">
          <option value="30">30d</option>
          <option value="90">90d</option>
          <option value="180">180d</option>
        </select>
      </div>
      <div class="filter-row">
        <label>Amazon Selling</label>
        <select id="f_amazon">
          <option value="">Any</option>
          <option value="yes">Yes ‚Äî Amazon in</option>
          <option value="no">No ‚Äî Amazon out</option>
        </select>
      </div>
      <div class="filter-row">
        <label>ROI</label>
        <select id="f_roi">
          <option value="">Any</option>
          <option value="pos">Positive</option>
          <option value="neg">Negative</option>
          <option value="20">‚â• 20%</option>
          <option value="30">‚â• 30%</option>
          <option value="50">‚â• 50%</option>
        </select>
      </div>
    </div>
    <div style="display:flex;gap:10px;">
      <button class="btn btn-primary" onclick="runVelocityFilter()">Run Filter</button>
      <button class="btn btn-muted" onclick="clearVelocityFilter()">Clear All</button>
    </div>
  </div>

  <div style="margin-bottom:10px;font-size:13px;color:var(--muted);" id="velocityCount"></div>

  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>ASIN</th>
          <th>Title</th>
          <th>Price</th>
          <th>Rank</th>
          <th>Sellers</th>
          <th>Amazon?</th>
          <th>ROI</th>
          <th>BB Œî Price</th>
          <th>Seller Œî</th>
          <th>Rank Œî</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="velocityBody">
        <tr><td colspan="12" class="status-msg">Set filters above and click Run Filter</td></tr>
      </tbody>
    </table>
  </div>
</div>
<!-- END VELOCITY -->

<!-- ==================== ASIN DETAIL ==================== -->
<div class="page" id="page-detail">

  <div style="margin-bottom:16px;">
    <button class="btn btn-muted btn-sm" onclick="goBack()">‚Üê Back</button>
  </div>

  <div class="product-image-wrap">
    <img id="detailImage" class="product-image" src="" alt="Product"
         style="display:none;" onerror="this.style.display='none'"/>
    <div class="product-info">
      <div class="detail-header">
        <div>
          <div class="detail-title" id="detailAsin">‚Äî</div>
          <div class="detail-subtitle" id="detailTitle">‚Äî</div>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;">
          <button class="btn btn-orange btn-sm" onclick="toggleEditPanel()">‚úèÔ∏è Edit ASIN</button>
        </div>
      </div>
    </div>
  </div>

  <div class="panel collapsible" id="editPanel" style="margin-bottom:20px;">
    <h3>Override Per-ASIN Values</h3>
    <div class="form-row">
      <div class="form-group">
        <label>Cost Price ($)</label>
        <input type="number" id="editCost" step="0.01"/>
      </div>
      <div class="form-group">
        <label>FBA Fee Override ($)</label>
        <input type="number" id="editFba" step="0.01" placeholder="Leave blank for default"/>
      </div>
      <div class="form-group">
        <label>Referral % Override</label>
        <input type="number" id="editReferral" step="0.01" placeholder="e.g. 15 for 15%"/>
      </div>
      <div class="form-group">
        <label>Notes</label>
        <input type="text" id="editNotes"/>
      </div>
    </div>
    <div class="form-actions">
      <button class="btn btn-primary" onclick="saveAsinEdits()">Save</button>
      <button class="btn btn-muted" onclick="toggleEditPanel()">Cancel</button>
    </div>
  </div>

  <div class="metrics-grid" id="detailMetrics"></div>

  <div class="period-btns">
    <button class="period-btn active" onclick="setDetailPeriod(30, this)">30d</button>
    <button class="period-btn" onclick="setDetailPeriod(90, this)">90d</button>
    <button class="period-btn" onclick="setDetailPeriod(180, this)">180d</button>
    <button class="period-btn" onclick="setDetailPeriod(365, this)">1yr</button>
  </div>

  <div class="panel">
    <h3>Buy Box Price & Lowest New Price</h3>
    <div class="chart-container"><canvas id="chartPrice"></canvas></div>
  </div>

  <div class="panel">
    <h3>Sales Rank</h3>
    <div class="chart-container"><canvas id="chartRank"></canvas></div>
  </div>

  <div class="panel">
    <h3>Seller Count</h3>
    <div class="chart-container"><canvas id="chartSellers"></canvas></div>
  </div>

  <div class="panel">
    <h3>Delta Summary</h3>
    <table class="delta-table">
      <thead>
        <tr>
          <th>Metric</th>
          <th>Œî 30 Days</th>
          <th>Œî 90 Days</th>
          <th>Œî 180 Days</th>
        </tr>
      </thead>
      <tbody id="deltaTableBody"></tbody>
    </table>
  </div>

  <div class="panel">
    <h3>Purchase Sources</h3>
    <div id="sourcesList"></div>
    <div style="margin-top:16px;">
      <button class="btn btn-primary btn-sm" onclick="toggleAddSource()">+ Add Source</button>
    </div>
    <div class="collapsible" id="addSourcePanel" style="margin-top:16px;">
      <div class="source-row" style="font-size:11px;color:var(--muted);font-weight:600;">
        <span>SUPPLIER NAME</span>
        <span>URL</span>
        <span>COST ($)</span>
        <span>NOTES</span>
        <span></span>
      </div>
      <div class="source-row">
        <input type="text" id="newSupplier" placeholder="e.g. Walmart"/>
        <input type="text" id="newUrl" placeholder="https://..."/>
        <input type="number" id="newSourceCost" step="0.01" placeholder="0.00"/>
        <input type="text" id="newSourceNotes" placeholder="Optional"/>
        <button class="btn btn-success btn-sm" onclick="addSource()">Add</button>
      </div>
    </div>
  </div>

</div>
<!-- END DETAIL -->

<!-- ==================== SETTINGS ==================== -->
<div class="page" id="page-settings">
  <div class="panel">
    <h3>Global Cost Defaults</h3>
    <p style="font-size:13px;color:var(--muted);margin-bottom:20px;">
      These apply to all ASINs unless overridden per ASIN on the detail page.
    </p>
    <div class="settings-grid">
      <div class="setting-item">
        <label>Prep Fee ($ per unit)</label>
        <input type="number" id="sPrepFee" step="0.01" placeholder="e.g. 1.25"/>
        <span class="hint">Your 3PL or prep centre fee per item</span>
      </div>
      <div class="setting-item">
        <label>Shipping Rate ($ per lb)</label>
        <input type="number" id="sShippingRate" step="0.01" placeholder="e.g. 0.50"/>
        <span class="hint">Your cost to ship product to Amazon FBA</span>
      </div>
      <div class="setting-item">
        <label>Default FBA Fee ($)</label>
        <input type="number" id="sFbaFee" step="0.01" placeholder="e.g. 3.22"/>
        <span class="hint">Amazon FBA fulfilment fee ‚Äî override per ASIN if varies</span>
      </div>
    </div>
    <div class="form-actions" style="margin-top:24px;">
      <button class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
    </div>
    <div id="settingsSaved" style="display:none;color:var(--green);font-size:13px;margin-top:12px;">
      ‚úÖ Settings saved
    </div>
  </div>

  <div class="panel">
    <h3>About ROI Calculation</h3>
    <p style="font-size:13px;color:var(--muted);line-height:1.7;">
      <strong style="color:var(--text);">True Cost</strong> = Product Cost + Prep Fee + (Weight √ó Shipping Rate)<br>
      <strong style="color:var(--text);">Amazon Fees</strong> = (Sale Price √ó Referral %) + FBA Fee<br>
      <strong style="color:var(--text);">Net Profit</strong> = Sale Price ‚àí Amazon Fees ‚àí True Cost<br>
      <strong style="color:var(--text);">ROI</strong> = Net Profit √∑ True Cost √ó 100<br><br>
      Referral % is automatically mapped from the product category pulled from Keepa.
      You can override FBA fee and referral % per ASIN on the detail page.
    </p>
  </div>
</div>
<!-- END SETTINGS -->

<script>
const API = "https://asin-tracker.onrender.com";

let allAsins      = [];
let allDeltas     = {};
let settings      = { prep_fee: 0, shipping_rate: 0, fba_fee: 3.22 };
let dashSortKey   = null;
let dashSortDir   = 1;
let currentDetailAsin = null;
let detailPeriod  = 30;
let previousPage  = "dashboard";
let priceChart = null, rankChart = null, sellersChart = null;

const REFERRAL_FEES = {
  "baby": 0.08, "beauty": 0.08, "clothing": 0.17, "apparel": 0.17,
  "grocery": 0.08, "food": 0.08, "health": 0.08, "home": 0.15,
  "kitchen": 0.15, "office": 0.15, "pet": 0.15, "sports": 0.15,
  "outdoors": 0.15, "tools": 0.15, "improvement": 0.15, "toys": 0.15,
  "games": 0.15, "arts": 0.15, "crafts": 0.15, "automotive": 0.12,
  "industrial": 0.12, "musical": 0.15, "patio": 0.15, "lawn": 0.15, "garden": 0.15,
};

function getReferralFee(category) {
  if (!category) return 0.15;
  const lower = category.toLowerCase();
  for (const [key, val] of Object.entries(REFERRAL_FEES)) {
    if (lower.includes(key)) return val;
  }
  return 0.15;
}

function calcROI(asin) {
  const price = parseFloat(asin.current_price || asin.current_new_price || 0);
  const cost  = parseFloat(asin.cost || 0);
  if (!price || !cost) return null;
  const prepFee      = parseFloat(settings.prep_fee || 0);
  const shippingRate = parseFloat(settings.shipping_rate || 0);
  const weight       = parseFloat(asin.weight || 0);
  const fbaFee       = parseFloat(asin.fba_fee || settings.fba_fee || 3.22);
  const referralPct  = asin.referral_fee_override
    ? parseFloat(asin.referral_fee_override) / 100
    : getReferralFee(asin.category);
  const trueCost   = cost + prepFee + (weight * shippingRate);
  const amazonFees = (price * referralPct) + fbaFee;
  const netProfit  = price - amazonFees - trueCost;
  const roi        = (netProfit / trueCost) * 100;
  return { roi, netProfit, trueCost, amazonFees };
}

function showPage(name) {
  document.querySelectorAll(".page").forEach(p => p.classList.remove("active"));
  document.querySelectorAll(".nav-btn").forEach(b => b.classList.remove("active"));
  document.getElementById("page-" + name).classList.add("active");
  document.querySelectorAll(".nav-btn").forEach(b => {
    if (b.textContent.toLowerCase().includes(name.replace("-","").substring(0,4)))
      b.classList.add("active");
  });
  previousPage = name;
}

function goBack() {
  showPage(previousPage === "detail" ? "dashboard" : previousPage);
}

async function loadAll() {
  await Promise.all([loadSettings(), loadAsins()]);
}

async function loadSettings() {
  try {
    const res  = await fetch(`${API}/settings`);
    const data = await res.json();
    settings = { ...settings, ...data };
    document.getElementById("sPrepFee").value      = settings.prep_fee || "";
    document.getElementById("sShippingRate").value = settings.shipping_rate || "";
    document.getElementById("sFbaFee").value       = settings.fba_fee || "";
  } catch(e) { console.error("Settings load error", e); }
}

async function loadAsins() {
  try {
    const res = await fetch(`${API}/asins`);
    allAsins  = await res.json();
    await loadAllDeltas();
    updateStats();
    renderDashboard();
  } catch(e) {
    document.getElementById("dashBody").innerHTML =
      `<tr><td colspan="11" class="status-msg">Error loading data.</td></tr>`;
  }
}

async function loadAllDeltas() {
  try {
    const res  = await fetch(`${API}/deltas`);
    const data = await res.json();
    allDeltas  = data;
  } catch(e) {
    console.error("Delta load error", e);
  }
}

function updateStats() {
  document.getElementById("statTotal").textContent = allAsins.length;
  document.getElementById("statAmazon").textContent =
    allAsins.filter(a => a.amazon_selling).length;
  document.getElementById("statPriceUp").textContent =
    allAsins.filter(a => allDeltas[a.asin]?.price_delta_30 > 0).length;
  document.getElementById("statSellersDown").textContent =
    allAsins.filter(a => allDeltas[a.asin]?.seller_delta_30 < 0).length;
  document.getElementById("statRoiPos").textContent =
    allAsins.filter(a => { const r = calcROI(a); return r && r.roi > 0; }).length;
}

function dashSort(key) {
  if (dashSortKey === key) dashSortDir *= -1;
  else { dashSortKey = key; dashSortDir = 1; }
  renderDashboard();
}

function renderDashboard() {
  const search = (document.getElementById("dashSearch").value || "").toLowerCase();
  let rows = allAsins.map(a => ({ ...a, roi: calcROI(a)?.roi ?? null }));
  if (search) {
    rows = rows.filter(r =>
      r.asin.toLowerCase().includes(search) ||
      (r.title || "").toLowerCase().includes(search)
    );
  }
  if (dashSortKey) {
    rows.sort((a, b) => {
      const av = a[dashSortKey] ?? -Infinity;
      const bv = b[dashSortKey] ?? -Infinity;
      return typeof av === "string" ? av.localeCompare(bv) * dashSortDir : (av - bv) * dashSortDir;
    });
  }
  if (!rows.length) {
    document.getElementById("dashBody").innerHTML =
      `<tr><td colspan="11" class="status-msg">No ASINs found.</td></tr>`;
    return;
  }
  document.getElementById("dashBody").innerHTML = rows.map(r => {
    const roiCalc = calcROI(r);
    const roiStr  = roiCalc
      ? `<span class="${roiCalc.roi >= 0 ? 'roi-positive':'roi-negative'}">${roiCalc.roi.toFixed(1)}%</span>`
      : `<span class="no-data">‚Äî</span>`;
    return `<tr>
      <td><span class="asin-link" onclick="openDetail('${r.asin}')">${r.asin}</span></td>
      <td class="title-cell" title="${r.title||''}">${r.title||'<span class="no-data">‚Äî</span>'}</td>
      <td>${r.current_price != null ? '$'+Number(r.current_price).toFixed(2) : (r.current_new_price != null ? '$'+Number(r.current_new_price).toFixed(2) : '<span class="no-data">‚Äî</span>')}</td>
      <td>${r.current_rank != null ? Number(r.current_rank).toLocaleString() : '<span class="no-data">‚Äî</span>'}</td>
      <td>${r.current_sellers ?? '<span class="no-data">‚Äî</span>'}</td>
      <td>${r.amazon_selling ? '<span class="badge-amz">AMZ</span>' : '<span class="no-data">‚Äî</span>'}</td>
      <td>${r.weight != null ? Number(r.weight).toFixed(2)+' lb' : '<span class="no-data">‚Äî</span>'}</td>
      <td>${r.cost != null ? '$'+Number(r.cost).toFixed(2) : '<span class="no-data">‚Äî</span>'}</td>
      <td>${roiStr}</td>
      <td style="display:flex;gap:6px;">
        <button class="btn btn-primary btn-sm" onclick="openDetail('${r.asin}')">View</button>
        <button class="btn btn-danger btn-sm" onclick="deleteAsin('${r.asin}')">‚úï</button>
      </td>
    </tr>`;
  }).join("");
}

function toggleAdd() {
  document.getElementById("addPanel").classList.toggle("open");
}

async function addAsin() {
  const asin = document.getElementById("iAsin").value.trim().toUpperCase();
  if (!asin || asin.length !== 10) { alert("Please enter a valid 10-character ASIN."); return; }
  try {
    const res = await fetch(`${API}/asins`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        asin,
        cost:  parseFloat(document.getElementById("iCost").value) || null,
        notes: document.getElementById("iNotes").value.trim()
      })
    });
    if (res.status === 409) { alert("ASIN already exists."); return; }
    if (!res.ok) { const e = await res.json(); alert(e.error); return; }
    document.getElementById("iAsin").value  = "";
    document.getElementById("iCost").value  = "";
    document.getElementById("iNotes").value = "";
    toggleAdd();
    await loadAsins();
  } catch(e) { alert("Error: " + e.message); }
}

async function deleteAsin(asin) {
  if (!confirm(`Remove ${asin} from tracker?`)) return;
  await fetch(`${API}/asins/${asin}`, { method: "DELETE" });
  await loadAsins();
}

async function syncKeepa() {
  const status = document.getElementById("syncStatus");
  status.textContent = "Syncing...";
  try {
    const res  = await fetch(`${API}/sync`, { method: "POST" });
    const data = await res.json();
    status.textContent = `Last sync: ${new Date().toLocaleTimeString()} (${data.updated} updated)`;
    await loadAsins();
  } catch(e) {
    status.textContent = "Sync failed";
    alert("Sync error: " + e.message);
  }
}

function getDeltaForFilter(asin, metric, period) {
  const d = allDeltas[asin];
  if (!d) return null;
  return d[`${metric}_delta_${period}`] ?? null;
}

function runVelocityFilter() {
  const priceBBDir     = document.getElementById("f_price_bb_dir").value;
  const priceBBPeriod  = document.getElementById("f_price_bb_period").value;
  const priceNewDir    = document.getElementById("f_price_new_dir").value;
  const priceNewPeriod = document.getElementById("f_price_new_period").value;
  const sellersDir     = document.getElementById("f_sellers_dir").value;
  const sellersPeriod  = document.getElementById("f_sellers_period").value;
  const rankDir        = document.getElementById("f_rank_dir").value;
  const rankPeriod     = document.getElementById("f_rank_period").value;
  const amazonFilter   = document.getElementById("f_amazon").value;
  const roiFilter      = document.getElementById("f_roi").value;

  let results = allAsins.filter(a => {
    if (priceBBDir) {
      const d = getDeltaForFilter(a.asin, "price", priceBBPeriod);
      if (d === null) return false;
      if (priceBBDir === "up"   && d <= 0) return false;
      if (priceBBDir === "down" && d >= 0) return false;
    }
    if (priceNewDir) {
      const d = getDeltaForFilter(a.asin, "new_price", priceNewPeriod);
      if (d === null) return false;
      if (priceNewDir === "up"   && d <= 0) return false;
      if (priceNewDir === "down" && d >= 0) return false;
    }
    if (sellersDir) {
      const d = getDeltaForFilter(a.asin, "seller", sellersPeriod);
      if (d === null) return false;
      if (sellersDir === "up"   && d <= 0) return false;
      if (sellersDir === "down" && d >= 0) return false;
    }
    if (rankDir) {
      const d = getDeltaForFilter(a.asin, "rank", rankPeriod);
      if (d === null) return false;
      if (rankDir === "down" && d >= 0) return false;
      if (rankDir === "up"   && d <= 0) return false;
    }
    if (amazonFilter === "yes" && !a.amazon_selling) return false;
    if (amazonFilter === "no"  &&  a.amazon_selling) return false;
    if (roiFilter) {
      const r = calcROI(a);
      if (!r) return false;
      if (roiFilter === "pos" && r.roi <= 0) return false;
      if (roiFilter === "neg" && r.roi >= 0) return false;
      if (!isNaN(roiFilter) && r.roi < parseFloat(roiFilter)) return false;
    }
    return true;
  });

  document.getElementById("velocityCount").textContent =
    `${results.length} ASIN${results.length !== 1 ? "s" : ""} match your filters`;

  if (!results.length) {
    document.getElementById("velocityBody").innerHTML =
      `<tr><td colspan="12" class="status-msg">No ASINs match your current filters.</td></tr>`;
    return;
  }

  document.getElementById("velocityBody").innerHTML = results.map(r => {
    const d = allDeltas[r.asin] || {};
    const roiCalc = calcROI(r);
    const roiStr  = roiCalc
      ? `<span class="${roiCalc.roi >= 0 ? 'roi-positive':'roi-negative'}">${roiCalc.roi.toFixed(1)}%</span>`
      : `<span class="no-data">‚Äî</span>`;
    return `<tr>
      <td><span class="asin-link" onclick="openDetail('${r.asin}')">${r.asin}</span></td>
      <td class="title-cell" title="${r.title||''}">${r.title||'<span class="no-data">‚Äî</span>'}</td>
      <td>${r.current_price != null ? '$'+Number(r.current_price).toFixed(2) : (r.current_new_price != null ? '$'+Number(r.current_new_price).toFixed(2) : '<span class="no-data">‚Äî</span>')}</td>
      <td>${r.current_rank != null ? Number(r.current_rank).toLocaleString() : '<span class="no-data">‚Äî</span>'}</td>
      <td>${r.current_sellers ?? '<span class="no-data">‚Äî</span>'}</td>
      <td>${r.amazon_selling ? '<span class="badge-amz">AMZ</span>' : '<span class="no-data">‚Äî</span>'}</td>
      <td>${roiStr}</td>
      <td class="${deltaClass(d.price_delta_30)}">${fmtDelta(d.price_delta_30,'$')}</td>
      <td class="${deltaClass(d.seller_delta_30, true)}">${fmtDelta(d.seller_delta_30)}</td>
      <td class="${deltaClass(d.rank_delta_30, true)}">${fmtDelta(d.rank_delta_30)}</td>
      <td><button class="btn btn-primary btn-sm" onclick="openDetail('${r.asin}')">View</button></td>
    </tr>`;
  }).join("");
}

function clearVelocityFilter() {
  ["f_price_bb_dir","f_price_new_dir","f_sellers_dir","f_rank_dir","f_amazon","f_roi"]
    .forEach(id => document.getElementById(id).value = "");
  document.getElementById("velocityBody").innerHTML =
    `<tr><td colspan="12" class="status-msg">Set filters above and click Run Filter</td></tr>`;
  document.getElementById("velocityCount").textContent = "";
}

async function openDetail(asin) {
  currentDetailAsin = asin;
  detailPeriod = 30;
  previousPage = document.querySelector(".page.active").id.replace("page-","");

  document.querySelectorAll(".page").forEach(p => p.classList.remove("active"));
  document.getElementById("page-detail").classList.add("active");

  const a = allAsins.find(x => x.asin === asin);
  if (!a) return;

  document.getElementById("detailAsin").textContent  = asin;
  document.getElementById("detailTitle").textContent = a.title || "No title yet ‚Äî sync to populate";

  const imgEl = document.getElementById("detailImage");
  if (a.image_url) {
    imgEl.src = a.image_url;
    imgEl.style.display = "block";
  } else {
    imgEl.src = `https://ws-na.amazon-adsystem.com/widgets/q?_encoding=UTF8&ASIN=${asin}&Format=_SL160_&ID=AsinImage&MarketPlace=US&ServiceVersion=20070822&WS=1`;
    imgEl.style.display = "block";
  }

  document.getElementById("editCost").value     = a.cost || "";
  document.getElementById("editFba").value      = a.fba_fee || "";
  document.getElementById("editReferral").value = a.referral_fee_override || "";
  document.getElementById("editNotes").value    = a.notes || "";

  document.getElementById("editPanel").classList.remove("open");
  document.getElementById("addSourcePanel").classList.remove("open");

  const roiCalc = calcROI(a);
  const d = allDeltas[asin] || {};

  document.getElementById("detailMetrics").innerHTML = `
    <div class="metric-card"><div class="m-label">Buy Box Price</div>
      <div class="m-value">${a.current_price != null ? '$'+Number(a.current_price).toFixed(2) : '‚Äî'}</div></div>
    <div class="metric-card"><div class="m-label">Lowest New Price</div>
      <div class="m-value">${a.current_new_price != null ? '$'+Number(a.current_new_price).toFixed(2) : '‚Äî'}</div></div>
    <div class="metric-card"><div class="m-label">Sales Rank</div>
      <div class="m-value">${a.current_rank != null ? Number(a.current_rank).toLocaleString() : '‚Äî'}</div></div>
    <div class="metric-card"><div class="m-label">Sellers</div>
      <div class="m-value">${a.current_sellers ?? '‚Äî'}</div></div>
    <div class="metric-card"><div class="m-label">Weight</div>
      <div class="m-value">${a.weight != null ? Number(a.weight).toFixed(2)+' lb' : '‚Äî'}</div></div>
    <div class="metric-card"><div class="m-label">Category</div>
      <div class="m-value" style="font-size:13px;">${a.category || '‚Äî'}</div></div>
    <div class="metric-card"><div class="m-label">ROI</div>
      <div class="m-value ${roiCalc ? (roiCalc.roi >= 0 ? 'roi-positive':'roi-negative') : ''}">
        ${roiCalc ? roiCalc.roi.toFixed(1)+'%' : '‚Äî'}</div></div>
    <div class="metric-card"><div class="m-label">Net Profit</div>
      <div class="m-value ${roiCalc ? (roiCalc.netProfit >= 0 ? 'roi-positive':'roi-negative') : ''}">
        ${roiCalc ? '$'+roiCalc.netProfit.toFixed(2) : '‚Äî'}</div></div>
    <div class="metric-card"><div class="m-label">Amazon Selling?</div>
      <div class="m-value">${a.amazon_selling ? '<span class="badge-amz">YES</span>' : 'No'}</div></div>
  `;

  document.getElementById("deltaTableBody").innerHTML = `
    <tr><td>Buy Box Price</td>
      <td class="${deltaClass(d.price_delta_30)}">${fmtDelta(d.price_delta_30,'$')}</td>
      <td class="${deltaClass(d.price_delta_90)}">${fmtDelta(d.price_delta_90,'$')}</td>
      <td class="${deltaClass(d.price_delta_180)}">${fmtDelta(d.price_delta_180,'$')}</td></tr>
    <tr><td>Lowest New Price</td>
      <td class="${deltaClass(d.new_price_delta_30)}">${fmtDelta(d.new_price_delta_30,'$')}</td>
      <td class="${deltaClass(d.new_price_delta_90)}">${fmtDelta(d.new_price_delta_90,'$')}</td>
      <td class="${deltaClass(d.new_price_delta_180)}">${fmtDelta(d.new_price_delta_180,'$')}</td></tr>
    <tr><td>Sales Rank</td>
      <td class="${deltaClass(d.rank_delta_30, true)}">${fmtDelta(d.rank_delta_30)}</td>
      <td class="${deltaClass(d.rank_delta_90, true)}">${fmtDelta(d.rank_delta_90)}</td>
      <td class="${deltaClass(d.rank_delta_180, true)}">${fmtDelta(d.rank_delta_180)}</td></tr>
    <tr><td>Seller Count</td>
      <td class="${deltaClass(d.seller_delta_30, true)}">${fmtDelta(d.seller_delta_30)}</td>
      <td class="${deltaClass(d.seller_delta_90, true)}">${fmtDelta(d.seller_delta_90)}</td>
      <td class="${deltaClass(d.seller_delta_180, true)}">${fmtDelta(d.seller_delta_180)}</td></tr>
  `;

  await Promise.all([
    loadSources(asin),
    loadDetailCharts(asin, detailPeriod)
  ]);

  document.querySelectorAll(".period-btn").forEach(b => b.classList.remove("active"));
  document.querySelectorAll(".period-btn")[0].classList.add("active");
}

async function setDetailPeriod(days, btn) {
  detailPeriod = days;
  document.querySelectorAll(".period-btn").forEach(b => b.classList.remove("active"));
  btn.classList.add("active");
  await loadDetailCharts(currentDetailAsin, days);
}

async function loadDetailCharts(asin, days) {
  try {
    const res  = await fetch(`${API}/history/${asin}?days=${days}`);
    const data = await res.json();

    // Downsample based on time period to reduce noise
    const sampled = downsample(data, days);

    const labels    = sampled.map(r => new Date(r.captured_at).toLocaleDateString());
    const bbPrices  = sampled.map(r => r.buybox_price);
    const newPrices = sampled.map(r => r.new_price);
    const ranks     = sampled.map(r => r.rank);
    const sellers   = sampled.map(r => r.seller_count);

    drawChart("chartPrice", labels, [
      { label: "Buy Box Price", data: bbPrices,  borderColor: "#7c83ff", backgroundColor: "rgba(124,131,255,0.08)" },
      { label: "Lowest New",   data: newPrices,  borderColor: "#2ecc71", backgroundColor: "rgba(46,204,113,0.08)" }
    ], "$", priceChart, c => priceChart = c);

    drawChart("chartRank", labels, [
      { label: "Sales Rank", data: ranks, borderColor: "#f39c12", backgroundColor: "rgba(243,156,18,0.08)" }
    ], "", rankChart, c => rankChart = c);

    drawChart("chartSellers", labels, [
      { label: "Seller Count", data: sellers, borderColor: "#e74c3c", backgroundColor: "rgba(231,76,60,0.08)" }
    ], "", sellersChart, c => sellersChart = c);

  } catch(e) { console.error("Chart error", e); }
}

function downsample(data, days) {
  // 30d ‚Äî no downsampling, show every point
  if (days <= 30) return data;

  // Determine bucket size in days
  const bucketDays = days <= 90 ? 7 : 14;

  // Group data into buckets and average each bucket
  const buckets = {};

  data.forEach(row => {
    const dt = new Date(row.captured_at);
    // Round down to nearest bucket
    const bucketMs   = bucketDays * 24 * 60 * 60 * 1000;
    const bucketKey  = Math.floor(dt.getTime() / bucketMs) * bucketMs;
    if (!buckets[bucketKey]) {
      buckets[bucketKey] = {
        captured_at:  new Date(bucketKey).toISOString(),
        buybox_price: [],
        new_price:    [],
        rank:         [],
        seller_count: []
      };
    }
    if (row.buybox_price  != null) buckets[bucketKey].buybox_price.push(row.buybox_price);
    if (row.new_price     != null) buckets[bucketKey].new_price.push(row.new_price);
    if (row.rank          != null) buckets[bucketKey].rank.push(row.rank);
    if (row.seller_count  != null) buckets[bucketKey].seller_count.push(row.seller_count);
  });

  // Average each bucket
  return Object.values(buckets)
    .sort((a, b) => new Date(a.captured_at) - new Date(b.captured_at))
    .map(b => ({
      captured_at:  b.captured_at,
      buybox_price: b.buybox_price.length  ? avg(b.buybox_price)  : null,
      new_price:    b.new_price.length     ? avg(b.new_price)     : null,
      rank:         b.rank.length          ? Math.round(avg(b.rank)) : null,
      seller_count: b.seller_count.length  ? Math.round(avg(b.seller_count)) : null,
    }));
}

function avg(arr) {
  return arr.reduce((a, b) => a + b, 0) / arr.length;
}
function drawChart(canvasId, labels, datasets, prefix, existingChart, setChart) {
  if (existingChart) existingChart.destroy();
  const ctx   = document.getElementById(canvasId).getContext("2d");
  const chart = new Chart(ctx, {
    type: "line",
    data: { labels, datasets: datasets.map(d => ({
      ...d, tension: 0.3, pointRadius: labels.length > 60 ? 0 : 3, fill: true, spanGaps: true
    }))},
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { labels: { color: "#aaa", font: { size: 12 } } },
        tooltip: {
          callbacks: {
            label: ctx => prefix
              ? `${ctx.dataset.label}: ${prefix}${Number(ctx.raw||0).toFixed(2)}`
              : `${ctx.dataset.label}: ${ctx.raw}`
          }
        }
      },
      scales: {
        x: { ticks: { color: "#666", maxTicksLimit: 10 }, grid: { color: "#1e2138" } },
        y: { ticks: { color: "#666", callback: v => prefix ? prefix+v : v }, grid: { color: "#1e2138" } }
      }
    }
  });
  setChart(chart);
}

function toggleEditPanel() {
  document.getElementById("editPanel").classList.toggle("open");
}

async function saveAsinEdits() {
  const payload  = {};
  const cost     = document.getElementById("editCost").value;
  const fba      = document.getElementById("editFba").value;
  const referral = document.getElementById("editReferral").value;
  const notes    = document.getElementById("editNotes").value;
  if (cost     !== "") payload.cost = parseFloat(cost);
  if (fba      !== "") payload.fba_fee = parseFloat(fba);
  if (referral !== "") payload.referral_fee_override = parseFloat(referral);
  if (notes    !== "") payload.notes = notes;
  try {
    await fetch(`${API}/asins/${currentDetailAsin}`, {
      method: "PATCH",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    toggleEditPanel();
    await loadAsins();
    await openDetail(currentDetailAsin);
  } catch(e) { alert("Save error: " + e.message); }
}

async function loadSources(asin) {
  try {
    const res  = await fetch(`${API}/sources/${asin}`);
    const rows = await res.json();
    const container = document.getElementById("sourcesList");
    if (!rows.length) {
      container.innerHTML = `<p style="color:var(--muted);font-size:13px;">No sources added yet.</p>`;
      return;
    }
    container.innerHTML = `
      <div class="source-row" style="font-size:11px;color:var(--muted);font-weight:600;padding-bottom:6px;">
        <span>SUPPLIER</span><span>URL</span><span>COST</span><span>NOTES</span><span></span>
      </div>
      ${rows.map(s => `
        <div class="source-row" id="source-${s.id}">
          <span style="font-size:13px;">${s.supplier_name || '<span class="no-data">‚Äî</span>'}</span>
          <a href="${s.url}" target="_blank" class="source-link" title="${s.url}">${s.url}</a>
          <span style="font-size:13px;">${s.cost != null ? '$'+Number(s.cost).toFixed(2) : '<span class="no-data">‚Äî</span>'}</span>
          <span style="font-size:13px;color:var(--muted);">${s.notes || ''}</span>
          <button class="btn btn-danger btn-sm" onclick="deleteSource('${s.id}')">‚úï</button>
        </div>
      `).join("")}
    `;
  } catch(e) { console.error("Load sources error", e); }
}

function toggleAddSource() {
  document.getElementById("addSourcePanel").classList.toggle("open");
}

async function addSource() {
  const url = document.getElementById("newUrl").value.trim();
  if (!url) { alert("URL is required."); return; }
  const payload = {
    asin:          currentDetailAsin,
    supplier_name: document.getElementById("newSupplier").value.trim(),
    url,
    cost:          parseFloat(document.getElementById("newSourceCost").value) || null,
    notes:         document.getElementById("newSourceNotes").value.trim()
  };
  try {
    const res = await fetch(`${API}/sources`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    if (!res.ok) { const e = await res.json(); alert(e.error); return; }
    document.getElementById("newSupplier").value    = "";
    document.getElementById("newUrl").value         = "";
    document.getElementById("newSourceCost").value  = "";
    document.getElementById("newSourceNotes").value = "";
    document.getElementById("addSourcePanel").classList.remove("open");
    await loadSources(currentDetailAsin);
  } catch(e) { alert("Error adding source: " + e.message); }
}

async function deleteSource(id) {
  if (!confirm("Remove this source?")) return;
  try {
    await fetch(`${API}/sources/${id}`, { method: "DELETE" });
    await loadSources(currentDetailAsin);
  } catch(e) { alert("Error deleting source: " + e.message); }
}

async function saveSettings() {
  const data = {
    prep_fee:      document.getElementById("sPrepFee").value,
    shipping_rate: document.getElementById("sShippingRate").value,
    fba_fee:       document.getElementById("sFbaFee").value,
  };
  try {
    await fetch(`${API}/settings`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data)
    });
    settings = { ...settings, ...data };
    const saved = document.getElementById("settingsSaved");
    saved.style.display = "block";
    setTimeout(() => saved.style.display = "none", 3000);
    renderDashboard();
  } catch(e) { alert("Error saving settings: " + e.message); }
}

function deltaClass(val, invert = false) {
  if (val == null) return "no-data";
  if (val === 0)   return "delta-zero";
  const pos = val > 0;
  return (invert ? !pos : pos) ? "delta-up" : "delta-down";
}

function fmtDelta(val, prefix = "") {
  if (val == null) return '<span class="no-data">‚Äî</span>';
  const sign = val > 0 ? "+" : "";
  return `${sign}${prefix}${Number(val).toFixed(2)}`;
}

loadAll();
</script>
</body>
</html>
